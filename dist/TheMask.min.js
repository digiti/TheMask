/*! TheMask 29-07-2015 */
!function(a,b){"use strict";var c=function(a){var b=(this.processOptions(a),this.validator(),this.analyzer(),this.build());this.info("build : "+b)};c.VERSION="0.0.1",a.TheMask=c,c.prototype.processOptions=function(a){this.data={},this.defs={},this.target=null,this.duration=null,this.easing=null,this.data.opt=a,this.requiredOptions=["target"],this.defaultOptions={duration:1e3,easing:"easeInOutQuart"},this.data.image=null,this.data.masks=null,this.data.alternative=null,this.data.targetID=null;var b=!0,c=this;for(var d in a)c.hasOwnProperty(d)&&null==c[d]&&(c[d]=a[d]);for(var e in c)if(null==c[e]&&this.defaultOptions.hasOwnProperty(e)){var f=this.defaultOptions[e];c[e]=f}for(var e in c)null==c[e]&&-1!==this.requiredOptions.indexOf(e)?(b=!1,this.warn('Required option "'+e+" was not passed as option!")):null!==c[e]&&-1!==this.requiredOptions.indexOf(e);return delete this.requiredOptions,delete this.defaultOptions,b?(b=null,!0):(this.warn("Not all options were accepted!"),!1)},c.prototype.validator=function(){var a=!0;return this.target&&"#"==this.target.charAt(0)?(this.$el=$(this.target),this.set("targetID",this.target.substring(1)),delete this.target):a=!1,a},c.prototype.analyzer=function(){var a=this,b=function(){return a.data.opt.hasOwnProperty("image")&&a.data.opt.hasOwnProperty("masks")?!0:!1},c=function(){return a.$el.find(".image").length&&a.$el.find(".mask").length?!0:!1},d=function(){var b=$(a.$el.find(".alternative"));a.data.alternative=b.html(),b.remove()},e=function(){return this.info("javascript data input not supported yet!"),!1},f=function(){var b=!0,c=$(a.$el.find(".image")[0]),d=a.$el.find(".mask");if(c){var e=c.data("dimensions").split(","),f=c.data("src");if(2==e.length&&f.length>1){var g={width:Number(e[0]),height:Number(e[1])};a.set("image",{src:f,dimensions:g}),b=!0}else a.warn("Problems with image src or dimensions!"),b=!1}else a.warn("Problems with provided image!"),b=!1;return b&&d&&d.length?d.each(function(b,c){var d=$(c),e=d.data("mask-id"),f=d.data("coords");a.parsePointStr(d.data("coords"));a.add("masks",{id:e,coords:f})}):(a.warn("Problems with provided masks!"),b=!1),b};return this.$el?(d(),b()?e():c()?f():(this.warn("Analyzer failed: Couldn't determine js or markup input."),!1)):(this.warn("Analyzer failed: $el not found!"),!1)},c.prototype.build=function(){var a=this,b=function(){var b=document.createElement("svg"),c=a.data.image.dimensions,d="0 0 "+c.width+" "+c.height,b=document.createElementNS("http://www.w3.org/2000/svg","svg");return b.setAttribute("version","1.1"),b.setAttribute("xmlns","http://www.w3.org/2000/svg"),b.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),b.setAttribute("viewBox",d),b.setAttribute("preserveAspectRatio","xMinYMin slice"),b},c=function(){var b=a.get("targetID")+"Masker",c=document.createElementNS("http://www.w3.org/2000/svg","clipPath");return c.setAttributeNS(null,"id",b),c},d=function(){var b=a.get("currentMask"),c=b.coords,d=document.createElementNS("http://www.w3.org/2000/svg","polygon");return d.setAttributeNS(null,"points",c),d},e=function(){var b=a.data.image,c=b.dimensions,d="#"+a.get("targetID")+"Masker",e="clip-path:url("+d+")",f=document.createElementNS("http://www.w3.org/2000/svg","image");return f.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",b.src),f.setAttributeNS(null,"width",c.width),f.setAttributeNS(null,"height",c.height),f.onload=function(){a.log("Loaded: xlink:href: "+b.src)},f.setAttributeNS(null,"style",e),f};return this.$el.html(""),this.defs.$svg=$(b()),this.defs.$cp=$(c()),this.defs.$p=$(d()),this.defs.$img=$(e()),this.defs.$cp.append(this.defs.$p),this.defs.$svg.append(this.defs.$cp),this.defs.$svg.append(this.defs.$img),this.$el.append(this.defs.$svg),!0},c.prototype.shapeMask=function(a){function c(a){var b=[];$(i).each(function(c,d){var e=i[c],f=l[c];b.push([e.x+Math.round(f.x*a),e.y+Math.round(f.y*a)].join(","))});var c=b.join(" ");k.attr("points",c)}var d=this,e=this.get("currentMask"),f=this.findMask(a);if(!f)return!1;d.set("currentMask",b);var g=e.coords,h=f.coords,i=this.parsePointStr(g),j=this.parsePointStr(h),k=this.defs.$p,l=[];$(i).each(function(a,b){var c=j[a],d=i[a];l.push({x:c.x-d.x,y:c.y-d.y})}),$({perc:0}).animate({perc:1},{duration:d.duration,easing:d.easing,step:function(a){c(this.perc)},complete:function(a){c(this.perc),d.set("currentMask",f)}})},c.prototype.get=function(a){return this.routedGetters.hasOwnProperty(a)?$.proxy(this.routedGetters[a],this)():this.data.hasOwnProperty(a)?this.data[a]:void this.warn('get("'+a+'") - No data property found by this name.')},c.prototype.set=function(a,b){return this.routedSetters.hasOwnProperty(a)?$.proxy(this.routedSetters[a],this)(b):void(this.data.hasOwnProperty(a)?b?this.data[a]=b:this.warn('set("'+a+'",...) - No value was defined.'):this.warn('set("'+a+'",...) - No data property found by this name.'))},c.prototype.add=function(a,c){this.data.hasOwnProperty(a)?((null==this.data[a]||this.data[a]==b)&&(this.data[a]=[]),c?this.data[a].push(c):this.warn('add("'+a+'",...) - No value was defined.')):this.warn('add("'+a+'",...) - No data collection found by this name.')},c.prototype.routedGetters={currentMask:function(){if(!this.data.hasOwnProperty("currentMask")){var a=this.data.masks;a.length&&(this.data.currentMask=a[0])}return this.data.currentMask}},c.prototype.routedSetters={currentMask:function(a){this.data.currentMask=a}},c.prototype.parsePointStr=function(a){var b=[];return a&&$(a.split(" ")).each(function(a,c){var d=c.split(",");b.push({x:Number(d[0]),y:Number(d[1])})}),b},c.prototype.findMask=function(a){for(var b=null,c=this.data.masks.length-1;c>=0;c--){var d=this.data.masks[c];d.id==a&&(b=d)}return b},c.prototype.log=function(a){console.log("TheMask: "+a)},c.prototype.warn=function(a){console.warn("TheMask: "+a)},c.prototype.info=function(a){console.info("TheMask: "+a)}}(this);