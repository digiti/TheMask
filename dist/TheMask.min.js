/*! TheMask 12-09-2015 */
!function(a,b){"use strict";var c=function(a){this.processOptions(a),this.validator(),this.analyzer(),this.build()};c.VERSION="0.1.0",a.TheMask=c,c.prototype.processOptions=function(a){this.data={},this.defs={},this.target=null,this.duration=null,this.easing=null,this.data.opt=a,this.requiredOptions=["target"],this.defaultOptions={duration:1e3,easing:"easeInOutQuart"},this.data.image=null,this.data.solid=null,this.data.masks=null,this.data.alternative=null,this.data.targetID=null;var b=!0,c=this;for(var d in a)c.hasOwnProperty(d)&&null==c[d]&&(c[d]=a[d]);for(var e in c)if(null==c[e]&&this.defaultOptions.hasOwnProperty(e)){var f=this.defaultOptions[e];c[e]=f}for(var e in c)null==c[e]&&-1!==this.requiredOptions.indexOf(e)?(b=!1,this.warn('Required option "'+e+" was not passed as option!")):null!==c[e]&&-1!==this.requiredOptions.indexOf(e);return delete this.requiredOptions,delete this.defaultOptions,b?(b=null,!0):(this.warn("Not all options were accepted!"),!1)},c.prototype.validator=function(){var a=!0;return this.target&&"#"==this.target.charAt(0)?(this.$el=$(this.target),this.set("targetID",this.target.substring(1)),delete this.target):a=!1,a},c.prototype.analyzer=function(){var a=this,b=function(){return a.data.opt.hasOwnProperty("image")&&a.data.opt.hasOwnProperty("masks")?!0:!1},c=function(){return(a.$el.find(".image").length||a.$el.find(".solid").length)&&a.$el.find(".mask").length?!0:!1},d=function(){var b=$(a.$el.find(".alternative"));a.data.alternative=b.html(),b.remove()},e=function(){return this.info("javascript data input not supported yet!"),!1},f=function(){var b=!0,c=a.$el.find(".image"),d=a.$el.find(".solid"),e=a.$el.find(".mask");if(c.length){var f=c.data("dimensions").split(","),g=c.data("src");if(2==f.length&&g.length>1){var h={width:Number(f[0]),height:Number(f[1])};a.set("image",{src:g,dimensions:h}),b=!0}else a.warn("Problems with image src or dimensions!"),b=!1}if(b&&d.length){var i=d.data("dimensions").split(","),j=d.data("fill"),k=d.data("stroke"),l=d.data("strokeWidth");if(2==i.length){var h={width:Number(i[0]),height:Number(i[1])};a.set("solid",{fill:j,stroke:k,strokeWidth:l,dimensions:h}),b=!0}else a.warn("Problems with solid dimensions!"),b=!1}return c.length||d.length||(b=!1,a.warn("Image AND solid are missing!")),b&&e&&e.length?e.each(function(b,c){var d=$(c),e=d.data("mask-id"),f=d.data("coords");a.parsePointStr(d.data("coords"));a.add("masks",{id:e,coords:f})}):(a.warn("Problems with provided masks!"),b=!1),b};return this.$el?(d(),b()?e():c()?f():(this.warn("Analyzer failed: Couldn't determine js or markup input."),!1)):(this.warn("Analyzer failed: $el not found!"),!1)},c.prototype.build=function(){function a(a){var d=new Image;d.onload=function(a){c.onLoad!==b&&c.onLoad(a)},d.src=a}var c=this,d=function(){var a,b=document.createElement("svg");c.get("image")?a=c.get("image").dimensions:c.get("solid")&&(a=c.get("solid").dimensions);var d="0 0 "+a.width+" "+a.height,b=document.createElementNS("http://www.w3.org/2000/svg","svg");return b.setAttribute("version","1.1"),b.setAttribute("xmlns","http://www.w3.org/2000/svg"),b.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),b.setAttribute("viewBox",d),b.setAttribute("preserveAspectRatio","xMidYMid slice"),b},e=function(){var a=document.createElementNS("http://www.w3.org/2000/svg","defs");return a},f=function(a){var b=c.get("targetID")+"Polygon",d=a.coords,e=document.createElementNS("http://www.w3.org/2000/svg","polygon");return e.setAttributeNS(null,"id",b),e.setAttributeNS(null,"points",d),e},g=function(){var a=c.get("targetID")+"Masker",b=document.createElementNS("http://www.w3.org/2000/svg","clipPath");return b.setAttributeNS(null,"id",a),b},h=function(){var a="#"+c.get("targetID")+"Polygon",b=document.createElementNS("http://www.w3.org/2000/svg","use");return b.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",a),b},i=function(a){var b=(a.dimensions,"#"+c.get("targetID")+"Polygon"),d=document.createElementNS("http://www.w3.org/2000/svg","use");return d.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",b),d.setAttributeNS(null,"x",0),d.setAttributeNS(null,"y",0),a.hasOwnProperty("fill")&&d.setAttributeNS(null,"fill",a.fill),a.hasOwnProperty("stroke")&&d.setAttributeNS(null,"stroke",a.stroke),a.hasOwnProperty("strokeWidth")&&d.setAttributeNS(null,"stroke-width",a.strokeWidth),d},j=function(b){var d=b.dimensions,e="#"+c.get("targetID")+"Masker",f="clip-path:url("+e+")",g=document.createElementNS("http://www.w3.org/2000/svg","image");return g.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",b.src),g.setAttributeNS(null,"width",d.width),g.setAttributeNS(null,"height",d.height),g.setAttributeNS(null,"style",f),a(b.src),g};this.$el.html("");var k=c.get("currentMask"),l=this.get("image"),m=this.get("solid");return this.defs.$svg=$(d()),this.defs.$defs=$(e()),this.defs.$p=$(f(k)),this.defs.$cp=$(g()),this.defs.$u=$(h()),this.defs.$defs.append(this.defs.$p),this.defs.$cp.append(this.defs.$u),this.defs.$svg.append(this.defs.$defs),this.defs.$svg.append(this.defs.$cp),this.get("solid")&&(this.defs.$solid=$(i(m)),this.defs.$svg.append(this.defs.$solid)),this.get("image")&&(this.defs.$img=$(j(l)),this.defs.$svg.append(this.defs.$img)),this.$el.append(this.defs.$svg),!0},c.prototype.shapeMask=function(a){function c(a){var b=[];$(k).each(function(c,d){var e=k[c],f=n[c];b.push([e.x+Math.round(f.x*a),e.y+Math.round(f.y*a)].join(","))});var c=b.join(" ");m.attr("points",c)}var d=this;if(a){var e=a.id,f=a.duration||this.duration,g=this.get("currentMask"),h=this.findMask(e);if(g.id==h.id)return!1;if(d.set("currentMask",b),g=this.get("currentMask"),!h)return!1;d.set("currentMask",b);var i=g.coords,j=h.coords,k=this.parsePointStr(i),l=this.parsePointStr(j),m=this.defs.$p,n=[];$(k).each(function(a,b){var c=l[a],d=k[a];n.push({x:c.x-d.x,y:c.y-d.y})}),this.hasOwnProperty("animation")&&(this.animation.clearQueue(),this.animation.stop(),delete this.animation),this.animation=$({perc:0}),this.animation.animate({perc:1},{duration:f,easing:d.easing,step:function(a){c(this.perc)},complete:function(b){c(this.perc),d.set("currentMask",h),a.hasOwnProperty("callback")&&a.callback()}})}},c.prototype.get=function(a){return this.routedGetters.hasOwnProperty(a)?$.proxy(this.routedGetters[a],this)():this.data.hasOwnProperty(a)?this.data[a]:void this.warn('get("'+a+'") - No data property found by this name.')},c.prototype.set=function(a,b){return this.routedSetters.hasOwnProperty(a)?$.proxy(this.routedSetters[a],this)(b):void(this.data.hasOwnProperty(a)?b?this.data[a]=b:this.warn('set("'+a+'",...) - No value was defined.'):this.warn('set("'+a+'",...) - No data property found by this name.'))},c.prototype.add=function(a,c){this.data.hasOwnProperty(a)?((null==this.data[a]||this.data[a]==b)&&(this.data[a]=[]),c?this.data[a].push(c):this.warn('add("'+a+'",...) - No value was defined.')):this.warn('add("'+a+'",...) - No data collection found by this name.')},c.prototype.routedGetters={currentMask:function(){if(!this.data.currentMask)if(this.defs.hasOwnProperty("$p")){var a=this.defs.$p,b=a.attr("points");this.data.currentMask={id:"undefined",coords:b}}else{var c=this.data.masks;c.length&&(this.data.currentMask=c[0])}return this.data.currentMask}},c.prototype.routedSetters={currentMask:function(a){this.data.currentMask=a}},c.prototype.parsePointStr=function(a){var b=[];return a&&$(a.split(" ")).each(function(a,c){var d=c.split(",");b.push({x:Number(d[0]),y:Number(d[1])})}),b},c.prototype.findMask=function(a){for(var b=null,c=this.data.masks.length-1;c>=0;c--){var d=this.data.masks[c];d.id==a&&(b=d)}return b},c.prototype.resetImage=function(a){var c=(this.defs.$img,this.data.image);if(a.hasOwnProperty("src")){var d=this.$el.find("image");d.attr("class","TheMask-remove");var e=c.dimensions,f="#"+this.get("targetID")+"Masker",g="clip-path:url("+f+");display:none;",h=document.createElementNS("http://www.w3.org/2000/svg","image");h.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",a.src),h.setAttributeNS(null,"width",e.width),h.setAttributeNS(null,"height",e.height),h.setAttributeNS(null,"style",g);var i=a.duration||this.duration;this.defs.$svg.append(h),$(h).fadeIn(i),$(d).fadeOut(i),setTimeout(function(){d.remove(),d=b,a.hasOwnProperty("callback")&&a.callback()},i),a.hasOwnProperty("shapeMask")&&this.shapeMask({id:a.shapeMask,duration:i})}else alert('TheMask: "src" attribute on "resetImage" command is missing.')},c.prototype.log=function(a){console.log("TheMask: "+a)},c.prototype.warn=function(a){console.warn("TheMask: "+a)},c.prototype.info=function(a){console.info("TheMask: "+a)}}(this);